<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>今日热点</title>
    <script>
        // var ua = navigator.userAgent.toLowerCase();
        // if (ua.match(/MicroMessenger/i) != "micromessenger") {
        //     location.href="/404"
        // }
    </script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/adaptive.js" type="text/javascript"></script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/common.js" type="text/javascript"></script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/EventEmitter.min.js"></script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/art-template.js"></script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/jf.js"></script>
    <script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/lottie.min.js"></script>
    <link href="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/css/index.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="show" style="display: none">
    <div style="height: 0.76rem;position: relative;line-height: 0.76rem">
        <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/hbts.png" style="height: 0.76rem;width: 100vw;padding:0;margin: 0;vertical-align: sub;position: absolute;top: 0;left: 0">
        <span id="tsText" style="position: absolute;left: 0.82rem;color: rgba(255, 56, 56, 1);font-size: 16px"></span>
    </div>
    <div style="padding: 0.32rem;padding-bottom: 1.2rem">
        <div id="title" style="color: #333333;font-size: 24px;font-weight: bolder;text-align: justify"></div>
        <!--文章内容-->
        <div id="contentParent" style="margin-top: 0.06rem;position: relative;height: 2.8rem;">
            <div id="content" style="position: absolute;top: 0;left: 0;overflow-y: hidden;height: 2.8rem;
        font-size: 18px;text-indent: 4em;line-height: 0.5rem;text-align:justify;width: 100%"></div>
            <div id="openAll" onclick="openAll()" style="position: absolute;top: 1.16rem;left: 0">
                <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/ckqw.png">
            </div>
        </div>

        <div style="margin-top: 0.36rem">
            <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/rmtj.png" style="height: 0.34rem">
        </div>

        <div id="dataList" style="padding-bottom: 1rem"></div>

        <div id="dynamicEffect" style="position: fixed;bottom: 0rem;width: 100%;left: 0;text-align: center">
        </div>
        <!--广告-->

        <div class="container" id="c1" style="display: none;padding-bottom: 3%;margin-top:0vh">
            <!--单图-->
            <script id="ad-template-info" type="text/html">
                <div class="ad-template-info"
                     style="display: flex;justify-content: space-between;height: 1.86rem;margin-top: 0.24rem"
                     onclick="Ad.adClick({{clickUrl}},{{dUrl}},{{pid}},1,getParam('from_user_id'),{{page}})">
                    <div style="width: 65%">
                        <div class="line-two"
                             style="font-size: 16px;color: #333333;font-weight: bolder;line-height: 0.44rem;">
                            {{ title }}
                        </div>
                        <div style="display: flex;justify-content: space-between;margin-top: 0.28rem">
                        <span style="color: rgba(255, 66, 55, 1);font-size: 14px;">
                            <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/xhb.png"
                                 style="margin-top: -0.04rem;margin-right: 0.06rem;width: 0.28rem;height: 0.28rem"><span>分享好友得1元红包</span>
                        </span>
                            <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/fxzq.png" style="height: 0.34rem;">
                        </div>
                    </div>
                    <div style="width: 2rem;height: 1.6rem;padding-right: 0rem;line-height: 1.4rem">
                        <img src="{{srcUrls[0]}}" style="height: 1.6rem;border-radius: 4px;">
                    </div>
                </div>
                <div style="height: 1px;background: #EEEEEE;width: 94vw;"></div>
            </script>
            <!--三图-->
            <script id="ad-template-3img" type="text/html">
                <div class="ad-template-3img" style="padding: 0.24rem 0"
                     onclick="Ad.adClick({{clickUrl}},{{dUrl}},{{pid}},2,getParam('from_user_id'),{{page}})">
                    <div class="line-two"
                         style="padding: 0 0rem;font-weight: bolder;line-height: 0.44rem;color: #333;font-size: 16px!important;">
                        {{ title }}
                    </div>
                    <div style="display: flex;justify-content: space-between;padding: 0 0rem;margin-top: 0.2rem">
                        {{ each srcUrls as value }}
                        <img style="height: 1.4rem;border-radius: 4px;" src="{{value}}" alt="">
                        {{ /each    }}
                    </div>
                    <div style="display: flex;justify-content: space-between;margin-top: 0.14rem;padding: 0 0rem">
                    <span style="color: rgba(255, 66, 55, 1);font-size: 14px;">
                        <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/xhb.png"
                             style="margin-top: -0.04rem;margin-right: 0.06rem;;width: 0.28rem;height: 0.28rem"><span>分享好友得1元红包</span>
                    </span>
                        <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/fxzq.png" style="height: 0.34rem;">
                    </div>
                </div>

                <div style="height: 1px;background: #EEEEEE;width: 94vw;"></div>
            </script>
            <!--大图-->
            <script id="ad-template-info-big" type="text/html">
                <div class="ad-template-info-big" style="padding: 0.24rem 0"
                     onclick="Ad.adClick({{clickUrl}},{{dUrl}},{{pid}},3,getParam('from_user_id'),{{page}})">
                    <div class="line-two"
                         style="padding: 0 0rem;font-weight: bolder;line-height: 0.44rem;color: #333;font-size: 16px!important;">
                        {{ title }}
                    </div>
                    <div style="display: flex;justify-content: space-between;padding: 0 0rem;margin-top: 0.2rem">
                        <img style="height: 4.56rem;width: 100%;border-radius: 4px;" src="{{srcUrls[0]}}" alt="">
                    </div>
                    <div  style="display: flex;justify-content: space-between;margin-top: 0.28rem;padding: 0 0rem">
                    <span style="color: rgba(255, 66, 55, 1);font-size: 14px;">
                        <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/xhb.png"
                             style="margin-top: -0.05rem;margin-right: 0.08rem;width: 0.28rem;height: 0.28rem"><span>分享好友得1元红包</span>
                    </span>
                        <img src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/img/fxzq.png" style="height: 0.34rem;">
                    </div>
                </div>
                <div style="height: 1px;background: #EEEEEE;width: 94vw;"></div>
            </script>
        </div>

    </div>
</div>

<script src="http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/adInfo.js"></script>
<script>
    var ip = ''
    var more_click = 0
    commonGet('/articles/' + getParam('article_id') + '?oa_id=' + getParam('oa_id') + '?from_user_id=' + getParam('from_user_id') + '', function (res) {
        if (res.code == 200) {
            $('#title').html(res.data.title)
            $('#content').html(res.data.content)
            $('#tsText').html('分享新闻给好友，每人阅读得' + res.data.price/10 + '元红包奖励')
            $('#dynamicEffect').click(function () {
                location.href = res.data.url + '/partake.html' + location.search + '&ip='+ ip +''
            })

            if (res.data.fission == 0) {
                location.href = './news_info_pure.html?' + location.search +''
            } else {
                $('#show').show()
                if (getParam('is_index') == 1) {
                    var page = {num: 1, size:10}
                    var maxPgae = 0
                    getText()
                    function getText () {
                        commonGet('/articles?page=' + page.num + '&per_page=' + page.size + '',
                            function (res) {
                                if (res.code == 200) {
                                    maxPgae = Math.ceil(res.meta.total/res.meta.per_page)
                                }
                                setListData(res.data, page)
                            }, {'ACT-USER-ID': getParam('user_id')})
                    }

                    var condition = true
                    setTimeout(() => {
                        $(window).scroll(function () {
                            var scrollTop = $(this).scrollTop();
                            var scrollHeight = $(document).height();
                            var windowHeight = $(this).height();

                            if (scrollTop + windowHeight + 150 >= scrollHeight && page.num < maxPgae) {
                                if (condition) {
                                    condition = false
                                    page.num++
                                    getText()
                                    setTimeout(function() {
                                        condition = true
                                    }, 1000)
                                }
                            }
                        })
                    }, 2000)
                } else {
                    var adListIndex = 0;
                    var adList = [];
                    var deny_cids = []; // 被禁止的创意广告id

                    var page = {num: 1, size:3}
                    var maxPgae = 0
                    getAds()

                    function getAds () {
                        commonGet('/adverts?page_type=7&page=' + page.num + '&per_page=' + page.size + '', function (res) {
                            if (res.code == 200) {
                                adList = res.data
                                maxPgae = res.meta.last_page
                            }
                            ee.emitEvent('fetch-jj-ad')
                        }, {'ACT-USER-ID': getParam('user_id')})
                    }

                    ee.addListener('fetch-jj-ad', function() {
                        var curData = adList[adListIndex];
                        Ad.singleAd(
                            $.extend(curData, {
                                data: {
                                    app_id: 103164,
                                    deny_cids: deny_cids.join(',')
                                }
                            }),
                            function(res) {
                                if (res && deny_cids.indexOf(res.cid) == -1) {
                                    /* 当前广告请求完毕后 将广告的cid(创意id)插入 deny_cids 用于防止广告重复 */
                                    deny_cids.push(res.cid); //插入创意id 用于广告位被重复广告占用
                                }
                                if (adListIndex === adList.length - 1) return;
                                adListIndex++;
                                /* 请求下个广告 */
                                ee.emitEvent('fetch-jj-ad');
                            }
                        );
                    });

                    var condition = true
                    setTimeout(() => {
                        $(window).scroll(function () {
                            var scrollTop = $(this).scrollTop();
                            var scrollHeight = $(document).height();
                            var windowHeight = $(this).height();

                            if (scrollTop + windowHeight + 150 >= scrollHeight && page.num < maxPgae) {
                                if (condition) {
                                    console.log('触发了吗')
                                    condition = false
                                    adListIndex = 0
                                    adList = []
                                    page.num++
                                    getAds()
                                    setTimeout(function() {
                                        condition = true
                                    }, 1000)
                                }
                            }
                        })

                    }, 2000)
                }
                function setListData(curPageData, page) {
                    var listDom = document.getElementById("dataList");
                    for (var i = 0; i < curPageData.length; i++) {
                        var pd = curPageData[i];
                        var str = '<div id="news'+ i +'" style="display: flex;justify-content: space-between;height: 2.05rem;padding-top: 0.24rem" onclick="goInfo(' + pd.id + ', ' + i + ')">\n' +
                            '            <div style="width: 65%;">\n' +
                            '                <div style="font-size: 16px;color: #333333;font-weight: bolder;line-height: 0.44rem;" class="line-two">' + pd.title + '</div>\n' +
                            '                <div style="display: flex;justify-content: space-between;margin-top: 0.28rem">\n' +
                            '                    <span  style="color: rgba(255, 66, 55, 1);font-size: 14px;"><img src="./img/xhb.png" style="margin-top: -0.08rem;margin-right: 0.12rem;width: 0.28rem;height: 0.28rem">' +
                            '<span>分享好友得'+ pd.price/10 +'元红包</span></span>\n' +
                            '                    <img src="./img/fxzq.png" style="height: 0.34rem;">\n' +
                            '                </div>\n' +
                            '            </div>\n' +
                            '            <div style="width: 2rem;height: 1.6rem;padding-right: 0.00rem;line-height: 1.4rem">\n' +
                            '                <img src="'+ pd.cover[0].path +'" style="height: 1.6rem;object-fit: cover;width: 2rem;border-radius: 4px;object-position: center">\n' +
                            '            </div>\n' +
                            '        </div><div style="height: 1px;background: #EEEEEE;width: 100%;margin-left: 0%"></div>';
                        var liDom = document.createElement("div");
                        liDom.setAttribute('id', 'adIndex'+ (i+1 + (page.num - 1)*page.size) +'')
                        liDom.innerHTML = str;
                        listDom.appendChild(liDom);
                    }
                }
            }

        }
    })



    var Ajax = {
        get: function (url, fn) {
            // XMLHttpRequest对象用于在后台与服务器交换数据
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.onreadystatechange = function () {
                // readyState == 4说明请求已完成
                if ((xhr.readyState == 4 && xhr.status == 200) || xhr.status == 304) {
                    // 从服务器获得数据
                    fn.call(this, xhr.responseText);
                }
            };
            xhr.send();
        },
    };

    Ajax.get(
        "https://1905658906400513.cn-shanghai.fc.aliyuncs.com/2016-08-15/proxy/getIp/getIp/",
        function (data) {
            var data_ip = JSON.parse(data);
            ip = data_ip.data.ip;
        }
    )

    function openAll() {
        more_click = 1
        $('#content').height('auto')
        $('#contentParent').height($('#content').height())
        $('#openAll').hide()
    }

    var anim = lottie.loadAnimation({
        container: document.getElementById("dynamicEffect"), // 容器
        renderer: "svg",
        loop: true,
        autoplay: true,
        // animationData: {}, //如果使用的是JSON
        path:
            "http://cp4gzh.oss-cn-shanghai.aliyuncs.com/static/js/lf20_zivk5lyq.json" // the path to the animation json
    });
    function setListData(curPageData, page) {
        var listDom = document.getElementById("dataList");
        for (var i = 0; i < curPageData.length; i++) {
            var pd = curPageData[i];
            var str = '<div id="news'+ i +'" style="display: flex;justify-content: space-between;height: 2.05rem;padding-top: 0.24rem" onclick="goInfo(' + pd.id + ', ' + i + ')">\n' +
                '            <div style="width: 65%;">\n' +
                '                <div style="font-size: 16px;color: #333333;font-weight: bolder;line-height: 0.44rem;" class="line-two">' + pd.title + '</div>\n' +
                '                <div style="display: flex;justify-content: space-between;margin-top: 0.28rem">\n' +
                '                    <span  style="color: rgba(255, 66, 55, 1);font-size: 14px;"><img src="./img/xhb.png" style="margin-top: -0.08rem;margin-right: 0.12rem;width: 0.28rem;height: 0.28rem">' +
                '<span>分享好友得'+ pd.price/10 +'元红包</span></span>\n' +
                '                    <img src="./img/fxzq.png" style="height: 0.34rem;">\n' +
                '                </div>\n' +
                '            </div>\n' +
                '            <div style="width: 2rem;height: 1.6rem;padding-right: 0.00rem;line-height: 1.4rem">\n' +
                '                <img src="'+ pd.cover[0].path +'" style="height: 1.6rem;object-fit: cover;width: 2rem;border-radius: 4px;object-position: center">\n' +
                '            </div>\n' +
                '        </div><div style="height: 1px;background: #EEEEEE;width: 100%;margin-left: 0%"></div>';
            var liDom = document.createElement("div");
            liDom.setAttribute('id', 'adIndex'+ (i+1 + (page.num - 1)*page.size) +'')
            liDom.innerHTML = str;
            listDom.appendChild(liDom);
        }
    }


    function goInfo (id, newId) {
        $('#news' + newId).addClass('news_active')

        var params = location.search
        var params1 = delParam(location.search, 'article_id')
        var params2 = delParam(params1, 'is_index')

        location.href = 'news_info.html'+ params2 +'&is_index=1&article_id='+ id +''
    }


    function gogg(url) {
        history.pushState(history.length + 1, 'message', window.location.href.split('#')[0] + '#' + new Date().getTime())
        if (navigator.userAgent.indexOf('Android') != -1) {
            if (typeof (tbsJs) != 'undefined') {
                tbsJs.onReady('{useCachedApi : "true"}', function (e) {
                })
                window.onhashchange = function () {
                    location.href = url
                }
            } else {
                var pop = 0
                window.onhashchange = function (event) {
                    pop++
                    if (pop >= 3) {
                        location.href = url
                    } else {
                        history.go(1)
                    }
                }
                history.go(-1)
            }
        } else {
            window.onhashchange = function () {
                location.href = url
            }
        }
    }

    var params = location.search
    if (getParam('from_user_id') == '' ||  getParam('from_user_id') == null) {
        gogg(location.origin + '/index.html' + delParam(location.search, 'article_id'))
    } else {
        gogg(location.origin + '/?isXxl=1')
    }

    function delParam(url, paramKey) {
        let beforeUrl = url.substr(0, url.indexOf("?"));   //?之前主地址
        let afterUrl = url.substr(url.indexOf("?") + 1);   //？之后参数路径
        let nextUrl = "";

        let arr = new Array();
        if (afterUrl != "") {
            let urlParamArr = afterUrl.split("&"); //将参数按照&符分成数组
            for (let i = 0; i < urlParamArr.length; i++) {
                let paramArr = urlParamArr[i].split("="); //将参数键，值拆开
                //如果键雨要删除的不一致，则加入到参数中
                if (paramArr[0] !== paramKey) {
                    arr.push(urlParamArr[i]);
                }
            }
        }
        if (arr.length > 0) {
            nextUrl = "?" + arr.join("&");
        }
        url = beforeUrl + nextUrl;
        return url;
    }
</script>
<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?8512ffd06625adc818b18eecba7b273b";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
</body>
</html>
